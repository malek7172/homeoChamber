<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prescription Report</title>
</head>

<body>

<h2>Prescription Report</h2>

<label>Filter by Patient:</label>
<select id="patientFilter"></select>
<button id="searchBtn">Search</button>

<br><br>

<table border="1" width="100%" id="reportTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Patient Name</th>
      <th>Symptoms</th>
      <th>Remedies</th>
      <th>Usage</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


<script src="app.js"></script>

<script>
// ================== CONFIG ==================
const API_URL = "YOUR_APPS_SCRIPT_WEBAPP_URL"; 
// ⚠️ Replace with your real Web App URL

// ================== FORMAT DATE ==================
function formatDate(isoDate) {
  if (!isoDate) return "";
  const d = new Date(isoDate);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

// ================== LOAD PATIENTS ==================
function loadPatientDropdown() {
  const select = document.getElementById("patientFilter");
  if (!select) return;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getPatients" })
  })
  .then(res => res.json())
  .then(response => {

    // If backend returns {status:"success", data:[...]}
    const data = Array.isArray(response) ? response : response.data;

    if (!Array.isArray(data)) {
      console.error("Patients data is not array:", response);
      return;
    }

    select.innerHTML = '<option value="">All Patients</option>';

    data.forEach(p => {
      select.innerHTML += `
        <option value="${p.id}">
          ${p.name}
        </option>`;
    });

  })
  .catch(err => console.error("Patient load error:", err));
}

// ================== LOAD REPORT ==================
function loadPrescriptionReport() {
  const patientSelect = document.getElementById("patientFilter");
  const tbody = document.querySelector("#reportTable tbody");

  if (!patientSelect || !tbody) return;

  const patientId = patientSelect.value;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "getPrescriptionReport",
      patientId: patientId
    })
  })
  .then(res => res.json())
  .then(response => {

    const data = Array.isArray(response) ? response : response.data;

    if (!Array.isArray(data)) {
      console.error("Report data not array:", response);
      return;
    }

    tbody.innerHTML = "";

    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" style="text-align:center;">
            No records found
          </td>
        </tr>`;
      return;
    }

    data.forEach(item => {
      tbody.innerHTML += `
        <tr>
          <td>${formatDate(item.date)}</td>
          <td>${item.patientName}</td>
          <td>${item.symptomes}</td>
          <td>${item.remedies}</td>
          <td>${item.usage}</td>
        </tr>`;
    });

  })
  .catch(err => console.error("Report load error:", err));
}

// ================== INIT ==================
document.addEventListener("DOMContentLoaded", function () {
  loadPatientDropdown();
  loadPrescriptionReport();

  document.getElementById("searchBtn")
    .addEventListener("click", loadPrescriptionReport);
});

// ================== SERVICE WORKER ==================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(() => console.log("Service Worker Registered"));
}
</script>

</body>
</html>
