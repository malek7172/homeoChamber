
<!DOCTYPE html>
<html>
<head>
  <title>Prescription</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
/* MENU BAR */
.menu-bar {
  background-color: #007bff; /* blue background */
  overflow: hidden;
  padding: 0;
  margin: 0;
}

.menu-bar ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
  display: flex;           /* <-- row-wise */
}

.menu-bar li {
  margin: 0;
}

.menu-bar li a {
  display: block;
  color: white;
  text-align: center;
  padding: 12px 20px;
  text-decoration: none;
  font-weight: bold;
}

.menu-bar li a:hover {
  background-color: #0056b3; /* darker on hover */
}
</style>
  <!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body onload="initPrescription()">
<nav class="menu-bar">
  <ul>
    <li><a href="dashboard.html">ğŸ  Dashboard</a></li>
    <li><a href="patient.html">ğŸ§¾ Patients</a></li>
    <li><a href="remedy.html">ğŸ’Š Remedies</a></li>
    <li><a href="prescription.html">ğŸ“„ Prescriptions</a></li>
   
    <li><a href="report.html">ğŸ“Š Reports</a></li>
    <li><a href="#" onclick="logout()">ğŸšª Logout</a></li>
  </ul>
</nav>
 
  
  
<h2>Prescription Entry</h2>


<label>Patient</label><br>

<input type="text" id="patientSearch" 
       placeholder="Search patient name or mobile..." 
       onkeyup="filterPatientList()">

<select id="patientSelect" size="5" 
        style="width:100%;"
        onchange="patientChanged()">
</select>

<br><br>
<label>Date</label><br>
<input type="date" id="pdate"><br><br>

<label>Symptoms</label><br>
<textarea id="symptoms"></textarea><br><br>

<label>Remedy</label><br>
<select id="remedySelect"></select>
<input type="text" id="power" placeholder="Power">
<button onclick="addRemedyRow()">Add Remedy</button>

<ul id="remedyList"></ul>

<label>Usage</label><br>
<textarea id="usage"></textarea><br><br>

<label>Previous Due</label><br>
<input type="number" id="previousDue" readonly><br><br>

<label>Fee</label><br>
<input type="number" id="fee" oninput="calculateTotal()"><br><br>

<label>Total</label><br>
<input type="number" id="total" readonly><br><br>

<label>Paid</label><br>
<input type="number" id="paid" oninput="calculateDue()"><br><br>

<label>Remaining Due</label><br>
<input type="number" id="due" readonly><br><br>

<label>Next Visit</label><br>
<input type="date" id="nextVisit"><br><br>

<button onclick="savePrescription()">Save Prescription</button>

<hr>
<h3>Prescription List</h3>


<input type="text" id="searchPatient" placeholder="Search patient..." onkeyup="filterPrescription()">

<br><br>
<table id="prescriptionTable" border="1">
  <thead>
    <tr>
      <th>Date</th>
      <th>Patient</th>
      <th>Symptoms</th>
      <th>Remedy</th>
      <th>Fee</th>
      <th>Paid</th>
      <th>Remaining</th>
    </tr>
  </thead>
  <tbody>
    <!-- rows will be inserted dynamically -->
  </tbody>
</table>
<script>
function patientChanged(){

  const patientId = document.getElementById("patientSelect").value;
  if(!patientId) return;

  post({
    action:"getLastPrescription",
    patientId: patientId
  }).then(res=>{

    if(res.success && res.data){

      const symptomsEl = document.getElementById("symptoms");
      const prevDueEl = document.getElementById("previousDue");

      if(symptomsEl)
        symptomsEl.value = res.data.symptoms || "";

      if(prevDueEl)
        prevDueEl.value = res.data.previousDue || 0;

    } else {

      // If no previous prescription
      document.getElementById("symptoms").value = "";
      document.getElementById("previousDue").value = 0;
    }

  }).catch(err=>{
    console.log("Error loading last prescription:", err);
  });
}
  $(document).ready(function() {
  // Apply searchable dropdown on patient select
  $('#patient').select2({
    placeholder: "Select a patient",
    allowClear: true,
    width: '100%'
  });
});
  // Store loaded prescriptions in a global variable
let prescriptionData = [];

// Initialize prescription list from server
function initPrescription() {
  post({ action: "getPrescriptions" })  // make sure GS returns patientName
    .then(data => {
      // Map data and format date
      prescriptionData = data.map(r => ({
        date: formatDate(r.date),           // format date for display
        patientName: r.patientName || "Unknown",
        fee: Number(r.fee) || 0,
        paid: Number(r.paid) || 0,
        remaining: Number(r.remaining) || 0
      }));
      renderPrescriptionTable(prescriptionData);
    })
    .catch(err => console.error("Error loading prescriptions:", err));
}

// Function to format ISO date to yyyy-mm-dd
<script>
// ===================== FORMAT DATE =====================
function formatDate(isoDate) {
  if (!isoDate) return "";
  const d = new Date(isoDate);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

// ===================== PRESCRIPTION DATA =====================
let prescriptionData = [];

// Load prescriptions from server
function loadPrescriptions(data) {
  prescriptionData = data.map(r => ({
    ...r,
    date: formatDate(r.date)  // format date immediately
  }));
  renderPrescriptionTable(prescriptionData);
}

// Render prescription table
function renderPrescriptionTable(data) {
  const tableBody = document.querySelector("#prescriptionTable tbody");
  tableBody.innerHTML = ""; // clear previous rows

  if (data.length === 0) {
    // show a "No matching records" row without hiding header
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center; color:gray;">
          No matching records
        </td>
      </tr>
    `;
    return;
  }

  data.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.date}</td>
      <td>${r.patientName}</td>
      <td>${r.symptoms || ""}</td>
      <td>${r.remedy || ""}</td>
      <td>${r.fee || 0}</td>
      <td>${r.paid || 0}</td>
      <td>${r.remaining || 0}</td>
    `;
    tableBody.appendChild(row);
  });
}

// ===================== FILTER PRESCRIPTIONS =====================
function filterPrescription() {
  const input = document.getElementById("searchPatient").value.toLowerCase();
  const filtered = prescriptionData.filter(p =>
    p.patientName.toLowerCase().includes(input)
  );
  renderPrescriptionTable(filtered);
}

// ===================== INIT FUNCTION =====================
function initPrescription() {
  // Load prescriptions from server
  post({ action: "getPrescriptions" })  // your server action to get all prescriptions
    .then(data => loadPrescriptions(data))
    .catch(err => console.error("Failed to load prescriptions:", err));
}

// Call init on page load
document.addEventListener("DOMContentLoaded", initPrescription);
</script>
</script>  
<script src="app.js"></script>

</body>
</html>
